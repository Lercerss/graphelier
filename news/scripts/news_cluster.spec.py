from unittest.mock import patch

from mamba import description, it
from sure import expect  # pylint: disable=W0611

from news_cluster import ArticleClustering

DATA = [ { 
        # CLUSTER 1
        "_id" : "5e83939a50a4aec3c75b0501",
        "article_url" : "https://www.reuters.com/article/us-china-health-apple/apple-to-shut-down-all-official-stores-in-chinese-mainland-due-to-virus-outbreak-idUSKBN1ZV3F5",
        "image_url" : "https://cdn.snapi.dev/images/v1/m/0/m02d20200201t2i1484319585rlynxmpeg102pvw640.jpg",
        "title" : "Apple to shut down all official stores in Chinese mainland due to virus outbreak",
        "text" : "(Reuters) - Apple Inc on Saturday said it would shut all of its official stores and corporate offices in mainland China until Feb 9. as fears over the coronavirus outbreak mounted and the death toll more than doubled to over 250 from a week ago. “Out of an abundance of caution and based on the latest advice from leading health experts, we’re closing all our corporate offices, stores, and contact centers in mainland China through February 9,” Apple said in a statement. The company said looked forward to re-opening stores “as soon as possible”. Earlier this week, Apple closed three stores in China due to concerns about the spread of the virus. It’s joining a handful of overseas retailers, including Starbucks Corp and McDonald’s Corp to temporarily shut storefronts as a precautionary measure. Many other companies, meanwhile, have called for employees in China to work from home and cease non-essential business travel in the first week of February. Normally, businesses in China would be preparing to return to normal operations following the end of the week-long Lunar New Year Holiday. Apple remains heavily reliant on China both for smartphone sales as well as for its supply chain and manufacturing. Many factories in Hubei province, including plants run by AB InBev and General Motors Co, have temporarily suspended production due to the virus. In a recent earnings call, Apple CEO Tim Cook said the company was working out mitigation plans to deal with possible production loss from its suppliers in Wuhan. The city where the virus outbreak originated is home to several Apple suppliers.",
        "source_name" : "Reuters",
        "date" : "Sat, 01 Feb 2020 02:29:57 -0500",
        "sentiment" : "Neutral",
        "tickers" : [ "AAPL" ],
        "summary" :"“Out of an abundance of caution and based on the latest advice from leading health experts, we’re closing all our corporate offices, stores, and contact centers in mainland China through February 9,” Apple said in a statement. The company said looked forward to re-opening stores “as soon as possible”. Earlier this week, Apple closed three stores in China due to concerns about the spread of the virus. Many other companies, meanwhile, have called for employees in China to work from home and cease non-essential business travel in the first week of February. Normally, businesses in China would be preparing to return to normal operations following the end of the week-long Lunar New Year Holiday. Many factories in Hubei province, including plants run by AB InBev and General Motors Co, have temporarily suspended production due to the virus. The city where the virus outbreak originated is home to several Apple suppliers.",
        "timestamp" : "1580542197"
    }, { 
        "_id" : "5e83939a50a4aec3c75b0500",
        "article_url" : "https://www.cnbc.com/2020/02/01/apple-temporarily-shuts-all-stores-and-offices-in-mainland-china.html",
        "image_url" : "https://cdn.snapi.dev/images/v1/1/0/105909721-1557753761959gettyimages-1142491520.jpeg",
        "title" : "Apple temporarily shuts all stores and offices in mainland China",
        "text" : "A woman using a smartphone walks past an Apple store in Shanghai, China, May 9, 2019. Qilai Shen | Bloomberg | Getty Images Apple has temporarily shut down all its stores in mainland China through Feb. 9, the company said on Saturday. The tech giant said in a statement on Saturday: \"Our thoughts are with the people most immediately affected by the Coronavirus and with those working around the clock to study and contain it.\" \"Out of an abundance of caution and based on the latest advice from leading health experts, we're closing all our corporate offices, stores and contact centers in mainland China through February 9,\" it said. Apple's online store in China will stay open, according to the statement. It added that it will continue to monitor the situation, and re-open its stores \"as soon as possible.\" Apple does the majority of its manufacturing in China, and considers it a key market. It shipped 3.2 million iPhones in China through December, according to CNBC calculations using government data, and that figure was up from 2.7 million units shipped in December 2018. China is a key growth area for Apple, which has struggled against low-cost phone makers that sell Android phones. Apple had hit a record high on Wednesday after topping earnings and sales estimates in its recent quarter.",
        "source_name" : "CNBC",
        "date" : "Sat, 01 Feb 2020 02:31:04 -0500",
        "sentiment" : "Neutral",
        "tickers" : [ "AAPL" ],
        "summary" : "A woman using a smartphone walks past an Apple store in Shanghai, China, May 9, 2019. Qilai Shen | Bloomberg | Getty Images Apple has temporarily shut down all its stores in mainland China through Feb. 9, the company said on Saturday. \"Out of an abundance of caution and based on the latest advice from leading health experts, we're closing all our corporate offices, stores and contact centers in mainland China through February 9,\" it said. Apple's online store in China will stay open, according to the statement. It added that it will continue to monitor the situation, and re-open its stores \"as soon as possible.\" Apple does the majority of its manufacturing in China, and considers it a key market. China is a key growth area for Apple, which has struggled against low-cost phone makers that sell Android phones.",
        "timestamp" : "1580542264"
    },
    # END OF CLUSTER 1
    # CLUSTER 2
    { 
        "_id" : "5e83939a50a4aec3c75b04ff",
        "article_url" : "https://www.fool.com/investing/2020/02/01/3-stocks-that-could-take-it-on-the-chin-due-to-the.aspx",
        "image_url" : "https://cdn.snapi.dev/images/v1/7/0/70pjccv-1.jpg",
        "title" : "3 Stocks That Could Take It On the Chin Due to the Coronavirus Outbreak",
        "text" : "In the weeks since it was initially identified, the coronavirus has become a global health crisis. The most recent numbers are chilling: nearly 10,000 cases have been confirmed, claiming more than 213 lives. The outbreak, which originated in Wuhan, China, has since been labeled as a public health emergency of international concern by the World Health Organization. The ongoing and persistent headlines concerning the illness have not gone unnoticed by Wall Street and uncertainty about the future has spread nearly as quickly as the virus. Naturally, many investors are wondering which stocks could feel the greatest impact in the wake of the epidemic. While a prolonged outbreak could drag down much of the stock market, there are several big name stocks that have a greater exposure to the potential fallout: Royal Caribbean Cruises (NYSE:RCL), Starbucks (NASDAQ:SBUX), and Apple (NASDAQ:AAPL). Two ships that passed in the night Travel is one of the most likely industries to be impacted by the coronavirus outbreak and cruise ship operators could be particularly vulnerable. Outbreaks are difficult to manage in confined spaces, which could cause some passengers to put off a planned cruise. In the wake of the outbreak, Royal Caribbean announced this week that at least three sailings of its Spectrum of the Seas ship have been canceled. The vessel, which makes its home port in China, had trips scheduled to depart from Shanghai between now and Feb. 8, and others could be at risk if travel restrictions remain in effect. More than 16% of Royal Caribbean's revenue is generated in the Asia-Pacific region and China represents 6% of the company's capacity for 2020. Bad press can also be a factor. Reports recently emerged that about 7,000 passengers were quarantined aboard a ship in Italy when a passenger from Macau showed symptoms of coronavirus. While this occurred on a rival company's cruise ship, Royal Caribbean expects \"an erosion of consumer confidence,\" which could eventually have a \"material impact on the overall financial performance of the company.\" Wedbush analyst James Hardiman estimates that \"every lost voyage is $3 [million] to $4 million in revenue.\" That number could actually be higher. After canceling the three trips noted above, Royal Caribbean estimated a financial impact of $0.10 per share, which works out to about $21 million. If travel restrictions remain in effect in China through the end of February, earnings could take an additional hit of $0.10 per share. Skipping the daily jolt of caffeine Over the past several years, Starbucks has been relying on China -- its second largest market -- as a significant part of its future growth plans, but with the emerging health crisis in the world's most populous country, those plans could stall. Starbucks had what would otherwise be considered a strong first quarter. Consolidated net revenue grew 9% year over year to $7.1 billion. Global comparable store sales grew 5%, and adjusted earnings per share grew to $0.79, up 5% compared to the prior-year quarter. The outbreak of coronavirus took center stage, however, as Starbucks said, \"Currently, we have closed more than half of our stores in China and continue to monitor and modify the operating hours of all of our stores in the market in response to the outbreak of the coronavirus.\" While these steps are expected to be temporary, Starbucks warned, \"Given the dynamic nature of these circumstances, the duration of business disruption, reduced customer traffic and related financial impact cannot be reasonably estimated at this time but are expected to materially affect our international segment and consolidated results for the second quarter and full year of fiscal 2020.\" Starbucks said it would update its forecast once it could \"reasonably estimate the impact\" of the outbreak on its results. An Apple a day More than most companies, Apple could get caught up in the outbreak of coronavirus. When the iPhone maker reported its fiscal first-quarter earnings, Apple execs downplayed any immediate impact from the epidemic. On the earnings conference call, Apple CEO Tim Cook had this to say: [W]e are closely following the development of the coronavirus. ... We are working closely with our team and our partners in the affected areas, and we have limited travel to business-critical situations as of last week. The situation is emerging, and we're still gathering lots of data points and monitoring it very closely. ... [W]e have a wider-than-usual revenue range for the second quarter due to the greater uncertainty. Part of that greater uncertainty results from the fact that nearly 15% of Apple's sales in the first quarter came from greater China, so anything that keeps Chinese consumers housebound would have a negative impact on results. Apple has thus far closed three retail stores and reported that a number of the company's retail partners have also shuttered their storefronts to ride out the outbreak. Perhaps more importantly, however, is the manufacturing aspect of the equation. The iPhone represented 61% of Apple's recent quarterly revenue and the majority of those iPhones are assembled in China. Many of the company's alternate suppliers are located in Wuhan, the epicenter of the outbreak. A number of manufacturing facilities in the country were already scheduled to be closed for the Lunar New Year, which Chinese officials have now extended in an effort to block the spread of the epidemic. Any extended closure of assembly lines could leave Apple scrambling to meet worldwide demand for its most popular product. In a statement, however, the company sought to downplay any potential disruption, saying, \"We can confirm that we have measures in place to ensure that we can continue to meet all global manufacturing obligations.\"",
        "source_name" : "The Motley Fool",
        "date" : "Sat, 01 Feb 2020 05:47:00 -0500",
        "sentiment" : "Negative",
        "tickers" : [ "AAPL", "RCL", "SBUX" ],
        "summary" : "The outbreak, which originated in Wuhan, China, has since been labeled as a public health emergency of international concern by the World Health Organization. The vessel, which makes its home port in China, had trips scheduled to depart from Shanghai between now and Feb. 8, and others could be at risk if travel restrictions remain in effect. The outbreak of coronavirus took center stage, however, as Starbucks said, \"Currently, we have closed more than half of our stores in China and continue to monitor and modify the operating hours of all of our stores in the market in response to the outbreak of the coronavirus.\" An Apple a day More than most companies, Apple could get caught up in the outbreak of coronavirus. Perhaps more importantly, however, is the manufacturing aspect of the equation. Many of the company's alternate suppliers are located in Wuhan, the epicenter of the outbreak. In a statement, however, the company sought to downplay any potential disruption, saying, \"We can confirm that we have measures in place to ensure that we can continue to meet all global manufacturing obligations.\"",
        "timestamp" : "1580554020"
    }
    # END OF CLUSTER 2
]

#This is the same data, but they were not created on the same day
DATA_SPACED_OUT = [ { 
        # CLUSTER 1
        "_id" : "5e83939a50a4aec3c75b0501",
        "article_url" : "https://www.reuters.com/article/us-china-health-apple/apple-to-shut-down-all-official-stores-in-chinese-mainland-due-to-virus-outbreak-idUSKBN1ZV3F5",
        "image_url" : "https://cdn.snapi.dev/images/v1/m/0/m02d20200201t2i1484319585rlynxmpeg102pvw640.jpg",
        "title" : "Apple to shut down all official stores in Chinese mainland due to virus outbreak",
        "text" : "(Reuters) - Apple Inc on Saturday said it would shut all of its official stores and corporate offices in mainland China until Feb 9. as fears over the coronavirus outbreak mounted and the death toll more than doubled to over 250 from a week ago. “Out of an abundance of caution and based on the latest advice from leading health experts, we’re closing all our corporate offices, stores, and contact centers in mainland China through February 9,” Apple said in a statement. The company said looked forward to re-opening stores “as soon as possible”. Earlier this week, Apple closed three stores in China due to concerns about the spread of the virus. It’s joining a handful of overseas retailers, including Starbucks Corp and McDonald’s Corp to temporarily shut storefronts as a precautionary measure. Many other companies, meanwhile, have called for employees in China to work from home and cease non-essential business travel in the first week of February. Normally, businesses in China would be preparing to return to normal operations following the end of the week-long Lunar New Year Holiday. Apple remains heavily reliant on China both for smartphone sales as well as for its supply chain and manufacturing. Many factories in Hubei province, including plants run by AB InBev and General Motors Co, have temporarily suspended production due to the virus. In a recent earnings call, Apple CEO Tim Cook said the company was working out mitigation plans to deal with possible production loss from its suppliers in Wuhan. The city where the virus outbreak originated is home to several Apple suppliers.",
        "source_name" : "Reuters",
        "date" : "Sat, 01 Feb 2020 02:29:57 -0500",
        "sentiment" : "Neutral",
        "tickers" : [ "AAPL" ],
        "summary" :"“Out of an abundance of caution and based on the latest advice from leading health experts, we’re closing all our corporate offices, stores, and contact centers in mainland China through February 9,” Apple said in a statement. The company said looked forward to re-opening stores “as soon as possible”. Earlier this week, Apple closed three stores in China due to concerns about the spread of the virus. Many other companies, meanwhile, have called for employees in China to work from home and cease non-essential business travel in the first week of February. Normally, businesses in China would be preparing to return to normal operations following the end of the week-long Lunar New Year Holiday. Many factories in Hubei province, including plants run by AB InBev and General Motors Co, have temporarily suspended production due to the virus. The city where the virus outbreak originated is home to several Apple suppliers.",
        "timestamp" : "1581542197"
    }, { 
        "_id" : "5e83939a50a4aec3c75b0500",
        "article_url" : "https://www.cnbc.com/2020/02/01/apple-temporarily-shuts-all-stores-and-offices-in-mainland-china.html",
        "image_url" : "https://cdn.snapi.dev/images/v1/1/0/105909721-1557753761959gettyimages-1142491520.jpeg",
        "title" : "Apple temporarily shuts all stores and offices in mainland China",
        "text" : "A woman using a smartphone walks past an Apple store in Shanghai, China, May 9, 2019. Qilai Shen | Bloomberg | Getty Images Apple has temporarily shut down all its stores in mainland China through Feb. 9, the company said on Saturday. The tech giant said in a statement on Saturday: \"Our thoughts are with the people most immediately affected by the Coronavirus and with those working around the clock to study and contain it.\" \"Out of an abundance of caution and based on the latest advice from leading health experts, we're closing all our corporate offices, stores and contact centers in mainland China through February 9,\" it said. Apple's online store in China will stay open, according to the statement. It added that it will continue to monitor the situation, and re-open its stores \"as soon as possible.\" Apple does the majority of its manufacturing in China, and considers it a key market. It shipped 3.2 million iPhones in China through December, according to CNBC calculations using government data, and that figure was up from 2.7 million units shipped in December 2018. China is a key growth area for Apple, which has struggled against low-cost phone makers that sell Android phones. Apple had hit a record high on Wednesday after topping earnings and sales estimates in its recent quarter.",
        "source_name" : "CNBC",
        "date" : "Sat, 01 Feb 2020 02:31:04 -0500",
        "sentiment" : "Neutral",
        "tickers" : [ "AAPL" ],
        "summary" : "A woman using a smartphone walks past an Apple store in Shanghai, China, May 9, 2019. Qilai Shen | Bloomberg | Getty Images Apple has temporarily shut down all its stores in mainland China through Feb. 9, the company said on Saturday. \"Out of an abundance of caution and based on the latest advice from leading health experts, we're closing all our corporate offices, stores and contact centers in mainland China through February 9,\" it said. Apple's online store in China will stay open, according to the statement. It added that it will continue to monitor the situation, and re-open its stores \"as soon as possible.\" Apple does the majority of its manufacturing in China, and considers it a key market. China is a key growth area for Apple, which has struggled against low-cost phone makers that sell Android phones.",
        "timestamp" : "1582542264"
    },
    # END OF CLUSTER 1
    # CLUSTER 2
    { 
        "_id" : "5e83939a50a4aec3c75b04ff",
        "article_url" : "https://www.fool.com/investing/2020/02/01/3-stocks-that-could-take-it-on-the-chin-due-to-the.aspx",
        "image_url" : "https://cdn.snapi.dev/images/v1/7/0/70pjccv-1.jpg",
        "title" : "3 Stocks That Could Take It On the Chin Due to the Coronavirus Outbreak",
        "text" : "In the weeks since it was initially identified, the coronavirus has become a global health crisis. The most recent numbers are chilling: nearly 10,000 cases have been confirmed, claiming more than 213 lives. The outbreak, which originated in Wuhan, China, has since been labeled as a public health emergency of international concern by the World Health Organization. The ongoing and persistent headlines concerning the illness have not gone unnoticed by Wall Street and uncertainty about the future has spread nearly as quickly as the virus. Naturally, many investors are wondering which stocks could feel the greatest impact in the wake of the epidemic. While a prolonged outbreak could drag down much of the stock market, there are several big name stocks that have a greater exposure to the potential fallout: Royal Caribbean Cruises (NYSE:RCL), Starbucks (NASDAQ:SBUX), and Apple (NASDAQ:AAPL). Two ships that passed in the night Travel is one of the most likely industries to be impacted by the coronavirus outbreak and cruise ship operators could be particularly vulnerable. Outbreaks are difficult to manage in confined spaces, which could cause some passengers to put off a planned cruise. In the wake of the outbreak, Royal Caribbean announced this week that at least three sailings of its Spectrum of the Seas ship have been canceled. The vessel, which makes its home port in China, had trips scheduled to depart from Shanghai between now and Feb. 8, and others could be at risk if travel restrictions remain in effect. More than 16% of Royal Caribbean's revenue is generated in the Asia-Pacific region and China represents 6% of the company's capacity for 2020. Bad press can also be a factor. Reports recently emerged that about 7,000 passengers were quarantined aboard a ship in Italy when a passenger from Macau showed symptoms of coronavirus. While this occurred on a rival company's cruise ship, Royal Caribbean expects \"an erosion of consumer confidence,\" which could eventually have a \"material impact on the overall financial performance of the company.\" Wedbush analyst James Hardiman estimates that \"every lost voyage is $3 [million] to $4 million in revenue.\" That number could actually be higher. After canceling the three trips noted above, Royal Caribbean estimated a financial impact of $0.10 per share, which works out to about $21 million. If travel restrictions remain in effect in China through the end of February, earnings could take an additional hit of $0.10 per share. Skipping the daily jolt of caffeine Over the past several years, Starbucks has been relying on China -- its second largest market -- as a significant part of its future growth plans, but with the emerging health crisis in the world's most populous country, those plans could stall. Starbucks had what would otherwise be considered a strong first quarter. Consolidated net revenue grew 9% year over year to $7.1 billion. Global comparable store sales grew 5%, and adjusted earnings per share grew to $0.79, up 5% compared to the prior-year quarter. The outbreak of coronavirus took center stage, however, as Starbucks said, \"Currently, we have closed more than half of our stores in China and continue to monitor and modify the operating hours of all of our stores in the market in response to the outbreak of the coronavirus.\" While these steps are expected to be temporary, Starbucks warned, \"Given the dynamic nature of these circumstances, the duration of business disruption, reduced customer traffic and related financial impact cannot be reasonably estimated at this time but are expected to materially affect our international segment and consolidated results for the second quarter and full year of fiscal 2020.\" Starbucks said it would update its forecast once it could \"reasonably estimate the impact\" of the outbreak on its results. An Apple a day More than most companies, Apple could get caught up in the outbreak of coronavirus. When the iPhone maker reported its fiscal first-quarter earnings, Apple execs downplayed any immediate impact from the epidemic. On the earnings conference call, Apple CEO Tim Cook had this to say: [W]e are closely following the development of the coronavirus. ... We are working closely with our team and our partners in the affected areas, and we have limited travel to business-critical situations as of last week. The situation is emerging, and we're still gathering lots of data points and monitoring it very closely. ... [W]e have a wider-than-usual revenue range for the second quarter due to the greater uncertainty. Part of that greater uncertainty results from the fact that nearly 15% of Apple's sales in the first quarter came from greater China, so anything that keeps Chinese consumers housebound would have a negative impact on results. Apple has thus far closed three retail stores and reported that a number of the company's retail partners have also shuttered their storefronts to ride out the outbreak. Perhaps more importantly, however, is the manufacturing aspect of the equation. The iPhone represented 61% of Apple's recent quarterly revenue and the majority of those iPhones are assembled in China. Many of the company's alternate suppliers are located in Wuhan, the epicenter of the outbreak. A number of manufacturing facilities in the country were already scheduled to be closed for the Lunar New Year, which Chinese officials have now extended in an effort to block the spread of the epidemic. Any extended closure of assembly lines could leave Apple scrambling to meet worldwide demand for its most popular product. In a statement, however, the company sought to downplay any potential disruption, saying, \"We can confirm that we have measures in place to ensure that we can continue to meet all global manufacturing obligations.\"",
        "source_name" : "The Motley Fool",
        "date" : "Sat, 01 Feb 2020 05:47:00 -0500",
        "sentiment" : "Negative",
        "tickers" : [ "AAPL", "RCL", "SBUX" ],
        "summary" : "The outbreak, which originated in Wuhan, China, has since been labeled as a public health emergency of international concern by the World Health Organization. The vessel, which makes its home port in China, had trips scheduled to depart from Shanghai between now and Feb. 8, and others could be at risk if travel restrictions remain in effect. The outbreak of coronavirus took center stage, however, as Starbucks said, \"Currently, we have closed more than half of our stores in China and continue to monitor and modify the operating hours of all of our stores in the market in response to the outbreak of the coronavirus.\" An Apple a day More than most companies, Apple could get caught up in the outbreak of coronavirus. Perhaps more importantly, however, is the manufacturing aspect of the equation. Many of the company's alternate suppliers are located in Wuhan, the epicenter of the outbreak. In a statement, however, the company sought to downplay any potential disruption, saying, \"We can confirm that we have measures in place to ensure that we can continue to meet all global manufacturing obligations.\"",
        "timestamp" : "1583554020"
    }
    # END OF CLUSTER 2
]
with description('News Cluster:') as self:
    with it('should create 2 clusters'):
        with patch('news_cluster.fetch_all') as mock_fetch, patch('news_cluster.insert_cluster') as mock_insert:
            mock_fetch.return_value = DATA
            inserted_clusters = []
            mock_insert.side_effect = inserted_clusters.append

            ac = ArticleClustering(1.2)
            ac.run()

            # 2 clusters are created
            expect(len(inserted_clusters)).should.equal(2)
            
            actual_clustered_ids = sorted([[article['_id'] for article in cluster.articles] for cluster in inserted_clusters], key=len)
            expected_clustered_ids = [["5e83939a50a4aec3c75b04ff"], ["5e83939a50a4aec3c75b0501", "5e83939a50a4aec3c75b0500"]]
            for i, id_cluster in enumerate(expected_clustered_ids):
                expect(set(id_cluster)).should.equal(set(actual_clustered_ids[i]))
    
    with it('should create 3 clusters, because the articles do not appear on the same day'):
        with patch('news_cluster.fetch_all') as mock_fetch, patch('news_cluster.insert_cluster') as mock_insert:
            mock_fetch.return_value = DATA_SPACED_OUT
            inserted_clusters = []
            mock_insert.side_effect = inserted_clusters.append

            ac = ArticleClustering(1.2)
            ac.run()

            # 3 clusters are created
            expect(len(inserted_clusters)).should.equal(3)
